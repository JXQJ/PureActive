// ***********************************************************************
// Assembly         : PureActive.Serilog.Sink.Xunit
// Author           : SteveBu
// Created          : 10-23-2018
// License          : Licensed under MIT License, see https://github.com/PureActive/PureActive/blob/master/LICENSE
//
// Last Modified By : SteveBu
// Last Modified On : 11-20-2018
// ***********************************************************************
// <copyright file="XunitLoggerSink.cs" company="BushChang Corporation">
//     © 2018 BushChang Corporation. All rights reserved.
// </copyright>
// <summary></summary>
// ***********************************************************************
using System;
using Microsoft.Extensions.Logging;
using PureActive.Logger.Provider.Serilog.Configuration;
using PureActive.Logger.Provider.Serilog.Interfaces;
using PureActive.Logging.Abstractions.Types;
using PureActive.Serilog.Sink.Xunit.Extensions;
using PureActive.Serilog.Sink.Xunit.Interfaces;
using PureActive.Serilog.Sink.Xunit.Types;
using Serilog;
using Serilog.Formatting;
using Serilog.Formatting.Compact;
using Serilog.Formatting.Json;
using Xunit.Abstractions;

namespace PureActive.Serilog.Sink.Xunit.Sink
{
    /// <summary>
    /// Enum XUnitSerilogFormatter
    /// </summary>
    /// <autogeneratedoc />
    public enum XUnitSerilogFormatter
    {
        /// <summary>
        /// The none
        /// </summary>
        /// <autogeneratedoc />
        None,
        /// <summary>
        /// The json formatter
        /// </summary>
        /// <autogeneratedoc />
        JsonFormatter,
        /// <summary>
        /// The compact json formatter
        /// </summary>
        /// <autogeneratedoc />
        CompactJsonFormatter,
        /// <summary>
        /// The rendered json formatter
        /// </summary>
        /// <autogeneratedoc />
        RenderedJsonFormatter,
        /// <summary>
        /// The rendered compact json formatter
        /// </summary>
        /// <autogeneratedoc />
        RenderedCompactJsonFormatter
    }

    /// <summary>
    /// Class XunitLoggingSink.
    /// </summary>
    /// <autogeneratedoc />
    public static class XunitLoggingSink
    {
        /// <summary>
        /// Gets the x unit serilog formatter.
        /// </summary>
        /// <param name="xUnitSerilogFormatter">The x unit serilog formatter.</param>
        /// <returns>ITextFormatter.</returns>
        /// <autogeneratedoc />
        public static ITextFormatter GetXUnitSerilogFormatter(XUnitSerilogFormatter xUnitSerilogFormatter)
        {
            switch (xUnitSerilogFormatter)
            {
                case XUnitSerilogFormatter.JsonFormatter:
                    return new JsonFormatter();
                case XUnitSerilogFormatter.CompactJsonFormatter:
                    return new CompactJsonFormatter();
                case XUnitSerilogFormatter.RenderedJsonFormatter:
                    return new JsonFormatter(null, true);
                case XUnitSerilogFormatter.RenderedCompactJsonFormatter:
                    return new RenderedCompactJsonFormatter();
                default:
                    return null;
            }
        }

        /// <summary>
        /// Creates the x unit logger configuration.
        /// </summary>
        /// <param name="testOutputHelper">The test output helper.</param>
        /// <param name="loggerSettings">The logger settings.</param>
        /// <param name="xUnitSerilogFormatter">The x unit serilog formatter.</param>
        /// <returns>LoggerConfiguration.</returns>
        /// <exception cref="ArgumentNullException">
        /// testOutputHelper
        /// or
        /// loggerSettings
        /// </exception>
        /// <autogeneratedoc />
        public static LoggerConfiguration CreateXUnitLoggerConfiguration(ITestOutputHelper testOutputHelper,
            ISerilogLoggerSettings loggerSettings, XUnitSerilogFormatter xUnitSerilogFormatter)
        {
            if (testOutputHelper == null) throw new ArgumentNullException(nameof(testOutputHelper));
            if (loggerSettings == null) throw new ArgumentNullException(nameof(loggerSettings));

            var loggerConfiguration = LoggerConfigurationFactory.CreateDefaultLoggerConfiguration(loggerSettings);

            if (loggerSettings.LoggingOutputFlags.HasFlag(LoggingOutputFlags.XUnitConsole))
            {
                var jsonFormatter = GetXUnitSerilogFormatter(xUnitSerilogFormatter);

                var testConsoleLoggerSetting =
                    loggerSettings.GetOrRegisterSerilogLogDefaultLevel(LoggingOutputFlags.XUnitConsole);

                if (jsonFormatter != null)
                {
                    loggerConfiguration.WriteTo.XUnit(testOutputHelper, jsonFormatter,
                        testConsoleLoggerSetting.MinimumLogEventLevel, testConsoleLoggerSetting.LoggingLevelSwitch);
                }
                else
                {
                    loggerConfiguration.WriteTo.XUnit(testOutputHelper, testConsoleLoggerSetting.MinimumLogEventLevel,
                        XUnitLoggerConfigurationExtensions.DefaultOutputTemplate,
                        null, testConsoleLoggerSetting.LoggingLevelSwitch);
                }
            }

            if (loggerSettings.LoggingOutputFlags.HasFlag(LoggingOutputFlags.TestCorrelator))
            {
                var testCorrelatorLoggerSetting =
                    loggerSettings.GetOrRegisterSerilogLogDefaultLevel(LoggingOutputFlags.TestCorrelator);

                // Configuration switch to TestCorrelator
                loggerConfiguration.WriteTo.TestCorrelator(testCorrelatorLoggerSetting.MinimumLogEventLevel,
                    testCorrelatorLoggerSetting.LoggingLevelSwitch);
            }

            return loggerConfiguration;
        }

        /// <summary>
        /// Creates the x unit serilog factory.
        /// </summary>
        /// <param name="loggerSettings">The logger settings.</param>
        /// <param name="loggerConfiguration">The logger configuration.</param>
        /// <returns>IPureTestLoggerFactory.</returns>
        /// <exception cref="ArgumentNullException">
        /// loggerSettings
        /// or
        /// loggerConfiguration
        /// </exception>
        /// <autogeneratedoc />
        public static IPureTestLoggerFactory CreateXUnitSerilogFactory(ISerilogLoggerSettings loggerSettings, LoggerConfiguration loggerConfiguration)
        {
            if (loggerSettings == null) throw new ArgumentNullException(nameof(loggerSettings));
            if (loggerConfiguration == null) throw new ArgumentNullException(nameof(loggerConfiguration));

            var loggerFactory = LoggerConfigurationFactory.CreateSerilogFactory(loggerSettings, loggerConfiguration);

            loggerFactory.AddDebug();

            return new PureTestLoggerFactory(loggerFactory, loggerSettings);
        }

        /// <summary>
        /// Creates the x unit serilog factory.
        /// </summary>
        /// <param name="testOutputHelper">The test output helper.</param>
        /// <param name="loggerSettings">The logger settings.</param>
        /// <param name="xUnitSerilogFormatter">The x unit serilog formatter.</param>
        /// <returns>IPureTestLoggerFactory.</returns>
        /// <exception cref="ArgumentNullException">
        /// testOutputHelper
        /// or
        /// loggerSettings
        /// </exception>
        /// <autogeneratedoc />
        public static IPureTestLoggerFactory CreateXUnitSerilogFactory(ITestOutputHelper testOutputHelper,
            ISerilogLoggerSettings loggerSettings,
            XUnitSerilogFormatter xUnitSerilogFormatter = XUnitSerilogFormatter.None)
        {
            if (testOutputHelper == null) throw new ArgumentNullException(nameof(testOutputHelper));
            if (loggerSettings == null) throw new ArgumentNullException(nameof(loggerSettings));

            var loggerConfiguration =
                CreateXUnitLoggerConfiguration(testOutputHelper, loggerSettings, xUnitSerilogFormatter);

            return CreateXUnitSerilogFactory(loggerSettings, loggerConfiguration);
        }
    }
}